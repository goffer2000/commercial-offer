<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Форма коммерческого предложения</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input[type="text"], input[type="number"], input[type="date"], select {
      padding: 6px;
      width: 300px;
      font-size: 14px;
    }
    .inline {
      display: inline-block;
      margin-right: 20px;
    }
    .section {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }
    h1 {
      font-size: 20px;
    }
    h2 {
      font-size: 16px;
      margin-top: 20px;
    }
    .checkbox-group {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Форма коммерческого предложения</h1>
  <form method="post">
    <label>Адрес объекта:
      <input type="text" name="address" required />
    </label>
    <label>Наименование объекта:
      <input type="text" name="object_name" required />
    </label>
    <label>Дата:
      <input type="date" name="date" value="{{ current_date }}" required />
    </label>
    <label>Площадь покрытия (м²):
      <input type="number" name="area" id="area" step="0.1" required />
    </label>
    <label>Материал:
      <select name="material" id="material" required>
        <option value="">-- Выберите --</option>
        <option value="PERLATA">PERLATA</option>
        <option value="TACTITE">TACTITE</option>
        <option value="LimeWash">LimeWash</option>
        <option value="ISTRIA">ISTRIA P350</option>
      </select>
    </label>

    <div id="materialFields" class="section">
      <label>Количество основного материала (л):
        <input type="number" name="material_qty" id="material_qty" required />
      </label>
      <label>Стоимость (тг):
        <input type="number" name="material_cost" id="material_cost" required />
      </label>
    </div>

    <div id="aquawaxBlock" class="section" style="display: none;">
      <label>Количество AQUAWAX (л):
        <input type="number" name="aquawax_qty" id="aquawax_qty" />
      </label>
      <label>Стоимость AQUAWAX (тг):
        <input type="number" name="aquawax_cost" id="aquawax_cost" />
      </label>
    </div>

    <div id="baseLayerBlock" class="section" style="display: none;">
      <label>Базовый слой:
        <select name="base_layer" id="base_layer">
          <option value="">-- Выберите --</option>
        </select>
      </label>
      <label>Количество базового слоя (л):
        <input type="number" name="base_qty" id="base_qty" />
      </label>
      <label>Стоимость базового слоя (тг):
        <input type="number" name="base_cost" id="base_cost" />
      </label>
    </div>

    <div id="extraBlock" class="section" style="display: none;">
      <label>Доп. расходные материалы (тг):
        <input type="number" name="extra_cost" id="extra_cost" />
      </label>
    </div>

    <div id="primerBlock" class="section" style="display: none;">
      <label>Грунтовка (тг):
        <input type="number" name="primer_cost" id="primer_cost" />
      </label>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" name="include_work" id="include_work" />
      <label for="include_work" class="inline">Работы</label>
    </div>

    <div id="workBlock" class="section" style="display: none;">
      <label>Стоимость работ за 1 кв.м.:
        <input type="number" name="work_price" id="work_price" value="7000" step="0.01" />
      </label>
    </div>

    <br />
    <button type="submit">Сформировать PDF</button>
  </form>

  <script>
    const materialSelect = document.getElementById('material');
    const baseLayerSelect = document.getElementById('base_layer');
    const areaInput = document.getElementById('area');

    const matQty = document.getElementById('material_qty');
    const matCost = document.getElementById('material_cost');
    const baseQty = document.getElementById('base_qty');
    const baseCost = document.getElementById('base_cost');
    const extraCost = document.getElementById('extra_cost');
    const primerCost = document.getElementById('primer_cost');
    const aquawaxQty = document.getElementById('aquawax_qty');
    const aquawaxCost = document.getElementById('aquawax_cost');
    const workCheckbox = document.getElementById('include_work');
    const workBlock = document.getElementById('workBlock');

    function recalc() {
      const area = parseFloat(areaInput.value || 0);

      // основной материал
      let matFactor = 1;
      let matPrice = 0;
      switch (materialSelect.value) {
        case 'PERLATA': matFactor = 6; matPrice = 54200; break;
        case 'TACTITE': matFactor = 9; matPrice = 72000; break;
        case 'LimeWash': matFactor = 5; matPrice = 28000; break;
        case 'ISTRIA': matFactor = 0.8; matPrice = 10563; break;
      }
      const mQty = Math.ceil(area / matFactor);
      matQty.value = mQty;
      matCost.value = mQty * matPrice;

      // aquawax
      const isAqua = materialSelect.value === 'LimeWash' || materialSelect.value === 'ISTRIA';
      document.getElementById('aquawaxBlock').style.display = isAqua ? 'block' : 'none';
      if (isAqua) {
        const aqQty = Math.ceil(area / 16);
        aquawaxQty.value = aqQty;
        aquawaxCost.value = aqQty * 59000;
      }

      // base layer
      let showBase = false;
      baseLayerSelect.innerHTML = '<option value="">-- Выберите --</option>';
      if (materialSelect.value === 'PERLATA') {
        showBase = true;
        ['BaseColor Matt', 'Marshall Export2'].forEach(val => {
          const opt = new Option(val, val);
          baseLayerSelect.appendChild(opt);
        });
      }
      if (materialSelect.value === 'TACTITE') {
        showBase = true;
        ['BaseColor Satine', 'Dulux Bindo20'].forEach(val => {
          const opt = new Option(val, val);
          baseLayerSelect.appendChild(opt);
        });
      }
      document.getElementById('baseLayerBlock').style.display = showBase ? 'block' : 'none';
      document.getElementById('extraBlock').style.display = showBase ? 'block' : 'none';
      document.getElementById('primerBlock').style.display = showBase ? 'block' : 'none';

      // работы
      workBlock.style.display = workCheckbox.checked ? 'block' : 'none';

      // доп материалы и грунтовка
      const extraQty = Math.ceil(area / 35);
      extraCost.value = extraQty * 12000;
      const primerQty = Math.ceil(area / 16);
      primerCost.value = primerQty * 2500;
    }

    areaInput.addEventListener('input', recalc);
    materialSelect.addEventListener('change', recalc);
    workCheckbox.addEventListener('change', () => {
      workBlock.style.display = workCheckbox.checked ? 'block' : 'none';
    });

    matQty.addEventListener('input', () => {
      const price = matCost.value / matQty.value || 0;
      matCost.value = Math.round(matQty.value * price);
    });

    matCost.addEventListener('input', () => {
      const price = matCost.value / matQty.value || 0;
      matQty.value = Math.round(matCost.value / price);
    });

    baseQty.addEventListener('input', () => {
      baseCost.value = baseQty.value * (baseLayerSelect.value.includes('Dulux') || baseLayerSelect.value.includes('Marshall') ? 8000 : 27000);
    });

    baseCost.addEventListener('input', () => {
      const unit = (baseLayerSelect.value.includes('Dulux') || baseLayerSelect.value.includes('Marshall')) ? 8000 : 27000;
      baseQty.value = Math.round(baseCost.value / unit);
    });

    aquawaxQty.addEventListener('input', () => {
      aquawaxCost.value = aquawaxQty.value * 59000;
    });

    aquawaxCost.addEventListener('input', () => {
      aquawaxQty.value = Math.round(aquawaxCost.value / 59000);
    });

    extraCost.addEventListener('input', () => {
      const qty = Math.round(extraCost.value / 12000);
      document.getElementById('extra_cost').previousElementSibling.innerText = `Доп. расходные материалы (тг): (≈ ${qty} компл)`;
    });

    primerCost.addEventListener('input', () => {
      const qty = Math.round(primerCost.value / 2500);
      document.getElementById('primer_cost').previousElementSibling.innerText = `Грунтовка (тг): (≈ ${qty} л)`;
    });

  </script>
</body>
</html>
