<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Создание коммерческого предложения</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    label {
      display: block;
      margin-top: 12px;
    }
    input, select, button {
      font-size: 1rem;
      padding: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    .section {
      margin-bottom: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Форма коммерческого предложения</h1>
  <form method="POST">
    <div class="section">
      <label>Адрес объекта:
        <input type="text" name="address" required>
      </label>
      <label>Наименование объекта:
        <input type="text" name="object_name" required>
      </label>
      <label>Дата:
        <input type="date" name="date" value="{{ current_date }}" required>
      </label>
      <label>Площадь покрытия (м²):
        <input type="number" name="area" id="area" step="0.1" required>
      </label>
    </div>

    <div class="section">
      <label>Материал:
        <select name="material" id="material" required>
          <option value="">-- Выберите --</option>
          <option value="PERLATA">PERLATA</option>
          <option value="TACTITE">TACTITE</option>
          <option value="LimeWash">LimeWash</option>
          <option value="ISTRIA">ISTRIA</option>
        </select>
      </label>
      <label>Количество:
        <input type="number" name="material_qty" id="material_qty" required>
      </label>
      <label>Стоимость:
        <input type="number" name="material_cost" id="material_cost" required>
      </label>
    </div>

    <div id="base-section" class="section hidden">
      <label>Базовый слой:
        <select name="base_layer" id="base_layer"></select>
      </label>
      <label>Количество:
        <input type="number" name="base_qty" id="base_qty">
      </label>
      <label>Стоимость:
        <input type="number" name="base_cost" id="base_cost">
      </label>
    </div>

    <div id="aqua-section" class="section hidden">
      <strong>AQUAWAX</strong>
      <label>Количество:
        <input type="number" name="aquawax_qty" id="aquawax_qty" readonly>
      </label>
      <label>Стоимость:
        <input type="number" name="aquawax_cost" id="aquawax_cost" readonly>
      </label>
    </div>

    <button type="submit">Сформировать PDF</button>
  </form>

  <script>
    const materialSelect = document.getElementById("material");
    const baseLayerSelect = document.getElementById("base_layer");
    const baseSection = document.getElementById("base-section");
    const aquaSection = document.getElementById("aqua-section");
    const areaInput = document.getElementById("area");

    const materialQty = document.getElementById("material_qty");
    const materialCost = document.getElementById("material_cost");
    const baseQty = document.getElementById("base_qty");
    const baseCost = document.getElementById("base_cost");
    const aquaQty = document.getElementById("aquawax_qty");
    const aquaCost = document.getElementById("aquawax_cost");

    function updateForm() {
      const material = materialSelect.value;
      const area = parseFloat(areaInput.value || 0);

      let qty = 0, cost = 0;
      if (material === "PERLATA") {
        qty = Math.ceil(area / 6);
        cost = qty * 54200;
        showBase(["BaseColor Matt", "Marshall Export2"]);
        hideAqua();
      } else if (material === "TACTITE") {
        qty = Math.ceil(area / 9);
        cost = qty * 72000;
        showBase(["BaseColor Satine", "Dulux Bindo20"]);
        hideAqua();
      } else if (material === "LimeWash") {
        qty = Math.ceil(area / 5);
        cost = qty * 28000;
        hideBase();
        showAqua(area);
      } else if (material === "ISTRIA") {
        qty = Math.ceil(area / 0.8);
        cost = qty * 10563;
        hideBase();
        showAqua(area);
      } else {
        hideBase();
        hideAqua();
      }

      materialQty.value = qty;
      materialCost.value = cost;
    }

    function showBase(options) {
      baseSection.classList.remove("hidden");
      baseLayerSelect.innerHTML = "<option value=''>-- Выберите --</option>" +
        options.map(opt => `<option value="${opt}">${opt}</option>`).join('');

      baseLayerSelect.onchange = () => {
        const base = baseLayerSelect.value;
        const area = parseFloat(areaInput.value || 0);
        let qty = 0;
        let price = 0;

        if (["Dulux Bindo20", "Marshall Export2"].includes(base)) {
          qty = Math.ceil(area / 7);
        } else if (["BaseColor Matt", "BaseColor Satine"].includes(base)) {
          qty = Math.ceil(area / 9);
        }

        if (base === "BaseColor Matt" || base === "BaseColor Satine") price = 27000;
        if (base === "Dulux Bindo20") price = 8000;
        if (base === "Marshall Export2") price = 4000;

        baseQty.value = qty;
        baseCost.value = qty * price;
      };
    }

    function hideBase() {
      baseSection.classList.add("hidden");
      baseLayerSelect.innerHTML = "";
      baseQty.value = "";
      baseCost.value = "";
    }

    function showAqua(area) {
      aquaSection.classList.remove("hidden");
      const qty = Math.ceil(area / 16);
      const price = 59000;
      aquaQty.value = qty;
      aquaCost.value = qty * price;
    }

    function hideAqua() {
      aquaSection.classList.add("hidden");
      aquaQty.value = "";
      aquaCost.value = "";
    }

    materialSelect.addEventListener("change", updateForm);
    areaInput.addEventListener("input", updateForm);
  </script>
</body>
</html>
